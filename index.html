<!DOCTYPE html>
<html>
<head>
<title>Marketing Cloud API Helper</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-container">
  
  <!-- COLUMNA IZQUIERDA: FUNCIONALIDADES -->
  <aside id="macros-sidebar">
	<div class="sidebar-client-selector">
	  <h2>Cliente</h2>
      <select id="sidebarClientSelect">
        <option value="">Ninguno seleccionado</option>
      </select>
	</div>
    <h2>Vistas</h2>
    
    <div class="collapsible-group">
        <h3 class="collapsible-header">General</h3>
        <ul class="collapsible-content">
          <li><a class="macro-item" data-macro="docu">Documentación</a></li>
          <li><a class="macro-item" data-macro="configuracionAPIs">Configuración de APIs</a></li>
        </ul>
    </div>

    <div class="collapsible-group">
        <h3 class="collapsible-header">Data Extensions</h3>
        <ul class="collapsible-content">
          <li><a class="macro-item" data-macro="configuracionDE">Configuración de Data Extension</a></li>
          <li><a class="macro-item" data-macro="campos">Campos</a></li>
          <li><a class="macro-item" data-macro="gestionCampos">Gestión de Campos</a></li>
        </ul>
    </div>

    <div class="collapsible-group">
        <h3 class="collapsible-header">Funcionalidades</h3>
        <ul class="collapsible-content">
          <li><a class="macro-item" data-macro="calendario">Calendario</a></li>
          <li><a class="macro-item" data-macro="busquedaDE">Búsqueda de Data Extension</a></li>
          <li><a class="macro-item" data-macro="validadorEmail">Validador de Email</a></li>
          <li><a class="macro-item" data-macro="buscadorOrigenes">Buscador de Orígenes</a></li>
        </ul>
    </div>

  </aside>

  <!-- COLUMNA CENTRAL: CONTENIDO PRINCIPAL -->
  <main id="main-content">
    <!-- Menú Principal -->
    <div id="main-menu" class="main-menu-container" style="display: flex;">
      
      <div class="menu-group">
        <h3>Panel principal</h3>
        <div class="menu-buttons-container">
          <p class="info-text">
            Selecciona alguna de las funcionalidades del panel izquierdo.
         </p>
         <p class="info-text">
            Para que funcione, recuerda haber seleccionado un cliente que tendrás que haber configurado previamente en "Configuración de APIs"
         </p>
        </div>
      </div>
      
    </div>

    <!-- SECCIÓN DE DOCUMENTACIÓN -->
    <div id="documentacion-section" class="section">
      <div class="section-header">
        <button class="back-button">← Atrás</button>
      </div>
      <h2>Documentación</h2>
      
      <div class="tabs-container">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="guia-rapida">Guía Rápida</button>
          <button class="tab-button" data-tab="errores-comunes">Errores Comunes</button>
          <button class="tab-button" data-tab="comentarios-adicionales">Comentarios Adicionales</button>
        </div>
        
        <div id="guia-rapida" class="tab-content active">
          <h3>Flujo de Trabajo Principal</h3>
          <ol>
            <li><strong>Configurar un Cliente:</strong> Ve a <em>Configuración de APIs</em>. Introduce un nombre para tu proyecto o cliente, rellena los datos de la aplicación de Marketing Cloud (MID, Auth URI, Client ID, etc.) y pulsa "Guardar". La configuración se guardará localmente.</li>
            <li><strong>Recuperar Token:</strong> (Opcional) Puedes pulsar "Recuperar Token" en el menú de la izquierda para comprobar que tus credenciales son correctas. La aplicación lo hará automáticamente cuando ejecutes otras macros.</li>
            <li><strong>Configurar la Data Extension:</strong> Ve a <em>Configuración de Data Extension</em>. Define el nombre, descripción y carpeta. Si la DE es "Sendable", marca la casilla correspondiente.</li>
            <li><strong>Añadir Campos:</strong> Ve a la sección de <em>Campos</em>.
                <ul>
                    <li>Usa <b>"Añadir Fila"</b> para añadir campos manualmente.</li>
                    <li>Usa <b>"Importar..."</b> para pegar una lista de campos desde Excel o un CSV.</li>
                    <li>Define qué campos son Primary Key (PK) u obligatorios.</li>
                </ul>
            </li>
            <li><strong>Vincular Subscriber Key:</strong> Si tu DE es "Sendable", vuelve a <em>Configuración de Data Extension</em> y selecciona el campo que actuará como Subscriber Key en el menú desplegable.</li>
            <li><strong>Crear la Data Extension:</strong> Pulsa "Crear Data Extension" en el menú de la izquierda.</li>
          </ol>
          <h3>Gestión de Campos Existentes</h3>
           <ol>
            <li><strong>Seleccionar Cliente:</strong> Asegúrate de que el cliente correcto esté seleccionado en el menú lateral izquierdo.</li>
            <li><strong>Introducir External Key:</strong> Ve a <em>Gestión de Campos</em> e introduce la External Key de la Data Extension que quieres modificar.</li>
            <li><strong>Recuperar Campos:</strong> Pulsa "Recuperar campos" para cargar su estructura en la tabla de la sección <em>Campos</em> y "Recuperar Ids" para poblar la lista de campos a eliminar.</li>
            <li><strong>Modificar y Guardar:</strong> Añade, edita o elimina filas en la tabla de <em>Campos</em>. Cuando termines, pulsa "Crear campos" para aplicar los cambios (esta acción actualiza los existentes y añade los nuevos).</li>
            <li><strong>Eliminar un Campo:</strong> En <em>Gestión de Campos</em>, pulsa "Recuperar Ids", selecciona el campo a borrar de la lista y pulsa "Borrar campo".</li>
          </ol>
        </div>
        
        <div id="errores-comunes" class="tab-content">
            <ul>
                <li><strong>Error de autenticación:</strong> Revisa que el MID, Client ID y Client Secret sean correctos. Asegúrate de que la aplicación API creada en Marketing Cloud es de tipo "Server-to-Server".</li>
                <li><strong>La DE se crea en la carpeta raíz:</strong> Si quieres crear la DE en una carpeta específica, debes proporcionar el <strong>ID de la Carpeta</strong> (un número), no su nombre. Puedes encontrarlo en la URL al navegar a esa carpeta en Marketing Cloud.</li>
                <li><strong>DE Sendable sin Subscriber Key:</strong> Si marcas una DE como "Sendable", es <strong>obligatorio</strong> seleccionar un campo que actuará como Subscriber Key y que este campo esté marcado como "Obligatorio" en la tabla de campos.</li>
                <li><strong>Error "DE ya existe":</strong> Si intentas crear una DE con una External Key que ya existe en la Business Unit, la API devolverá un error.</li>
                <li><strong>Acceso a Business Units Hijas:</strong> La aplicación API debe crearse en la BU padre (Enterprise) y se le deben dar permisos explícitos para acceder a las BUs hijas que necesites.</li>
                <li><strong>Error "Bad Request" con enlaces:</strong> Si pegas una URL en un campo de texto que contiene un "&", la API SOAP puede fallar. Reemplaza <code>&</code> por <code>&amp;amp;</code> para solucionarlo.</li>
            </ul>
        </div>

        <div id="comentarios-adicionales" class="tab-content">
            <ul>
              <li><strong>Almacenamiento Local:</strong> Toda la configuración de tus clientes se guarda en el almacenamiento local de tu navegador. No se envía a ningún servidor externo. Si borras la caché de tu navegador o cambias de equipo, perderás esta información.</li>
              <li><strong>Permisos de la Aplicación API:</strong> Para un funcionamiento completo, la aplicación API en Marketing Cloud necesita permisos de Lectura y Escritura para Data Extensions (<code>Data > Data Extensions > Read & Write</code>), de Lectura para Automatizaciones (<code>Automations > Read</code>) y de Lectura para Email (<code>Email > Read</code>).</li>
              <li><strong>Creación vs. Actualización de Campos:</strong> La macro "Crear campos" es en realidad un "upsert". Esto significa que si un campo con el mismo nombre ya existe, actualizará sus propiedades. Si no existe, lo creará.</li>
              <li><strong>Tipos de Campo:</strong> Asegúrate de que los tipos de campo coinciden con los soportados por Marketing Cloud (Text, Number, Date, Boolean, EmailAddress, Phone, Locale, Decimal).</li>
              <li><strong>Longitud en Decimales:</strong> Para campos de tipo "Decimal", la longitud debe especificarse como "total,decimales". Por ejemplo, <code>18,2</code> para un campo que admite hasta 18 dígitos, con 2 de ellos siendo decimales.</li>
            </ul>
        </div>
      </div>
    </div>
    
    <!-- SECCIÓN DE CALENDARIO -->
    <div id="calendario-section" class="section">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
             <div class="calendar-controls">
                <label for="calendarYearSelect">Seleccionar año:</label>
                <select id="calendarYearSelect"></select>
                <button id="refreshAutomationsBtn" class="action-button">Refrescar Datos</button>
            </div>
        </div>
        <h2>Calendario de Automatizaciones de Journeys</h2>
        <div class="calendar-container">
            <div id="calendar-main" class="calendar-main-view">
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            <div id="calendar-sidebar" class="calendar-sidebar">
                <h3>Automatizaciones del día</h3>
                <div id="automation-list">
                    <p>Selecciona un día en el calendario o pulsa "Refrescar Datos" para empezar.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Configuración de APIs -->
    <div id="configuracion-apis-section" class="section config-section-container">
         <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions">
                <button id="getTokenBtn" class="action-button">Recuperar Token</button>
            </div>
        </div>
        <h2>Configuración de APIs</h2>
        <div class="client-management">
            <input type="text" id="clientName" placeholder="Nombre del Cliente">
            <select id="savedConfigs"></select>
            <button id="saveConfig">Guardar</button>
            <button id="deleteConfig" class="delete-btn">Borrar</button>
        </div>
        <div class="config-block">
            <h3>Datos Aplicación</h3>
            <div class="form-group"><label for="businessUnit">Business Unit (MID)</label><input type="text" id="businessUnit"></div>
            <div class="form-group"><label for="authUri">Auth URI</label><input type="text" id="authUri"></div>
            <div class="form-group"><label for="clientId">Client ID</label><input type="text" id="clientId"></div>
            <div class="form-group"><label for="clientSecret">Client Secret</label><input type="text" id="clientSecret"></div>
            <div class="form-group"><label for="token">Token</label><input type="text" id="token" disabled></div>
            <div class="form-group"><label for="soapUri">SOAP URI</label><input type="text" id="soapUri" disabled></div>
            <div class="form-group"><label for="restUri">REST URI</label><input type="text" id="restUri" disabled></div>
        </div>
        <p class="info-text">
            La configuración se guardará localmente en tu navegador. No se almacena en ningún servidor externo.
        </p>
    </div>

    <!-- Sección de Configuración de Data Extension -->
    <div id="configuracion-de-section" class="section config-section-container">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions">
                <button id="createDE" class="action-button">Crear Data Extension</button>
            </div>
        </div>
        <h2>Configuración de Data Extension</h2>
        <div class="config-block">
            <h3>Configuración Base DE</h3>
            <div class="form-group"><label for="deName">Nombre Data Extension</label><input type="text" id="deName"></div>
            <div class="form-group"><label for="deDescription">Descripción</label><input type="text" id="deDescription"></div>
            <div class="form-group"><label for="deExternalKey">External Key</label><input type="text" id="deExternalKey" disabled></div>
            <div class="form-group"><label for="deFolder">Carpeta</label><input type="text" id="deFolder"></div>
        </div>
        <div class="config-block">
            <h3>Configuración Sendable</h3>
            <div class="form-group checkbox-group">
                <label for="isSendable">Sendable DE:</label>
                <input type="checkbox" id="isSendable">
            </div>
            <div class="form-group">
                <label for="subscriberKeyField">Campo SubscriberKey</label>
                <select id="subscriberKeyField" disabled>
                    <option value="">-- Primero defina campos en la sección 'Campos' --</option>
                </select>
            </div>
            <div class="form-group"><label for="subscriberKeyType">Tipo Campo SubscriberKey</label><input type="text" id="subscriberKeyType" disabled></div>
        </div>
    </div>
    
    <!-- Sección de Búsqueda de DE -->
    <div id="busqueda-de-section" class="section config-section-container">
        <button class="back-button">← Atrás</button>
        <h2>Búsqueda de Data Extension</h2>
        <div class="config-block">
            <h3>Parámetros de Búsqueda</h3>
            <div class="form-group">
              <label for="deSearchProperty">Buscar por:</label>
              <select id="deSearchProperty">
                <option value="Name">Nombre</option>
                <option value="CustomerKey">External Key</option>
              </select>
            </div>
            <div class="form-group">
              <label for="deSearchValue">Valor:</label>
              <input type="text" id="deSearchValue" placeholder="Ingresa el valor de búsqueda" maxlength="128">
            </div>
            <div class="header-actions" style="justify-content: center; margin-top: 20px;">
               <button id="searchDEBtn" class="action-button">Buscar</button>
            </div>
        </div>
        <div class="config-block">
            <h3>Resultados</h3>
            <pre id="de-search-results">Los resultados de la búsqueda aparecerán aquí.</pre>
        </div>
    </div>

    <!-- Sección de Validador de Email -->
    <div id="email-validator-section" class="section config-section-container">
        <button class="back-button">← Atrás</button>
        <h2>Validador de Email</h2>
        <div class="config-block">
            <h3>Parámetros de Validación</h3>
            <div class="form-group">
              <label for="emailToValidate">Email a validar:</label>
              <input type="text" id="emailToValidate" placeholder="Introduce la dirección de email">
            </div>
            <div class="header-actions" style="justify-content: center; margin-top: 20px;">
               <button id="validateEmailBtn" class="action-button">Validar Email</button>
            </div>
        </div>
        <div class="config-block">
            <h3>Resultado de la Validación</h3>
            <pre id="email-validation-results">El resultado de la validación aparecerá aquí.</pre>
        </div>
    </div>
    
    <!-- Sección de Buscador de Orígenes de Datos (NUEVA) -->
    <div id="data-source-finder-section" class="section config-section-container">
        <button class="back-button">← Atrás</button>
        <h2>Buscador de Orígenes de Datos</h2>
        <div class="config-block">
            <h3>Parámetros de Búsqueda</h3>
            <div class="form-group">
              <label for="deNameToFind">Nombre de la Data Extension:</label>
              <input type="text" id="deNameToFind" placeholder="Introduce el nombre exacto de la DE">
            </div>
            <div class="header-actions" style="justify-content: center; margin-top: 20px;">
               <button id="findDataSourcesBtn" class="action-button">Buscar Orígenes</button>
            </div>
        </div>
        <div class="config-block" style="flex-grow: 1; display: flex; flex-direction: column;">
            <h3>Actividades Encontradas</h3>
            <div class="table-container" style="flex-grow: 1; overflow-y: auto;">
                 <table id="data-sources-table">
                    <thead>
                        <tr>
                            <th>Actividad</th>
                            <th>Tipo</th>
                            <th>Automatización</th>
                            <th>Paso</th>
                            <th>Acción</th>
                            <th>Descripción / Query</th>
                        </tr>
                    </thead>
                    <tbody id="data-sources-tbody">
                        <!-- Los resultados se insertarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Sección de Configuración de Gestión de Campos -->
    <div id="configuracion-campos-section" class="section config-section-container">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions">
                <button id="getFields" class="action-button">Recuperar campos</button>
                <button id="deleteField" class="action-button">Borrar campo</button>
            </div>
        </div>

        <h2>Gestión de Campos de Data Extension</h2>
        
        <div class="config-block">
            <h3>Parámetros</h3>
            <p class="info-text" style="text-align: left; margin-top: 0; margin-bottom: 15px;">
                Introduce la External Key de la DE y pulsa "Recuperar Ids" o "Recuperar Campos" en el menú de la izquierda para poblar la lista.
            </p>
            <div class="form-group">
                <label for="recExternalKey">External Key de la DE</label>
                <input type="text" id="recExternalKey">
            </div>
            <div class="form-group">
                <label for="targetFieldSelect">Campo a eliminar</label>
                <select id="targetFieldSelect" disabled>
                    <option value="">-- Pulsa "Recuperar Ids" para poblar la lista --</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Sección de Campos -->
    <div id="campos-section" class="section">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions">
                <button id="importFieldsBtn" class="action-button">Importar...</button>
                <button id="addFieldBtn" class="action-button">Añadir Fila</button>
                <button id="createFieldsBtn" class="action-button">Crear campos</button>
                <button id="createDummyFieldsBtn" class="action-button">Crear Campos Dummy</button>                
                <button id="clearFieldsBtn" class="action-button delete-btn">Limpiar Campos</button>
            </div>
        </div>
        
        <h2>Campos de la Data Extension</h2>
        <div class="table-container">
          <table id="myTable">
            <thead>
              <tr><th>Campo MC</th><th>Tipo Campo</th><th>Longitud</th><th>Default</th><th>PK</th><th>Obligatorio</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="control-buttons">
            <button id="moveUp">Subir</button>
            <button id="moveDown">Bajar</button>
          </div>
        </div>
    </div>
  </main> 

  <!-- COLUMNA DERECHA: LOG -->
  <aside id="log-sidebar">
    <div class="log-header">
      <h2>Log de Eventos</h2>
      <button id="toggleLogBtn" title="Colapsar Log"></button>
    </div>
    <div id="log-message-block" class="log-block">
      <h4>Mensajes</h4>
      <pre><code id="log-messages">Esperando acciones...</code></pre>
    </div>
    <div id="log-request-block" class="log-block">
      <h4>Llamada</h4>
      <pre><code id="log-request"></code></pre>
    </div>
    <div id="log-response-block" class="log-block">
      <h4>Respuesta</h4>
      <pre><code id="log-response"></code></pre>
    </div>
  </aside>

</div>

<!-- MODAL DE IMPORTACIÓN -->
<div id="import-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Importar Campos desde Portapapeles</h3>
        <p>Pega aquí los datos de tu Excel o CSV. Las columnas deben ser: <b>Nombre</b>, <b>Tipo</b> y <b>Longitud</b>.</p>
        
        <div class="delimiter-selector">
            <label for="delimiter-select">Separador:</label>
            <select id="delimiter-select">
                <option value="tab" selected>Tabulador (Excel)</option>
                <option value="comma">Coma (,)</option>
                <option value="semicolon">Punto y coma (;)</option>
                <option value="other">Otro...</option>
            </select>
            <input type="text" id="custom-delimiter-input" class="hidden" maxlength="1" placeholder="Ej: |">
        </div>
        
        <textarea id="paste-data-area" rows="10" placeholder="Ciudad	Text	50&#10;Email	EmailAddress	254"></textarea>
        <div class="modal-actions">
            <button id="process-paste-btn" class="action-button">Añadir Campos</button>
            <button id="cancel-paste-btn" class="action-button delete-btn">Cancelar</button>
        </div>
    </div>
</div>

<script src="ui.js"></script>
</body>
</html>