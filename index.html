<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Marketing Cloud API Helper</title>
  <!-- Enlaza la hoja de estilos CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Contenedor principal de la aplicación con layout de rejilla (grid) -->
<div class="app-container">
  
  <!-- ========================================================== -->
  <!-- START: BARRA LATERAL IZQUIERDA (FUNCIONALIDADES) -->
  <!-- ========================================================== -->
  <aside id="macros-sidebar">
    <!-- Selector de Cliente -->
    <div class="sidebar-client-selector">
      <h2>Cliente</h2>
      <select id="sidebarClientSelect">
        <option value="">Ninguno seleccionado</option>
      </select>
    </div>
    
    <h2>Vistas</h2>
    
    <!-- Menús colapsables para agrupar funcionalidades -->
    <div class="collapsible-group">
        <h3 class="collapsible-header">General</h3>
        <ul class="collapsible-content">
          <li><a class="macro-item" data-macro="docu">Documentación</a></li>
          <li><a class="macro-item" data-macro="configuracionAPIs">Configuración de APIs</a></li>
        </ul>
    </div>

    <div class="collapsible-group">
        <h3 class="collapsible-header">Data Extensions</h3>
        <ul class="collapsible-content">
          <li><a class="macro-item" data-macro="configuracionDE">Configuración de Data Extension</a></li>
          <li><a class="macro-item" data-macro="campos">Campos</a></li>
          <li><a class="macro-item" data-macro="gestionCampos">Gestión de Campos</a></li>
        </ul>
    </div>

    <div class="collapsible-group">
        <h3 class="collapsible-header">Funcionalidades</h3>
        <ul class="collapsible-content">
          <li><a class="macro-item" data-macro="calendario">Calendario</a></li>
          <li><a class="macro-item" data-macro="busquedaDE">Búsqueda de Data Extension</a></li>
          <li><a class="macro-item" data-macro="validadorEmail">Validador de Email</a></li>
          <li><a class="macro-item" data-macro="buscadorOrigenes">Buscador de Orígenes</a></li>
        </ul>
    </div>
  </aside>
  <!-- END: BARRA LATERAL IZQUIERDA -->

  <!-- ========================================================== -->
  <!-- START: CONTENIDO PRINCIPAL (CENTRO) -->
  <!-- ========================================================== -->
  <main id="main-content">
    
    <!-- Pantalla de Bienvenida / Menú Principal -->
    <div id="main-menu" class="main-menu-container" style="display: flex;">
      <div class="menu-group">
        <h3>Panel Principal</h3>
        <div class="menu-buttons-container">
         <p class="info-text">
            Bienvenido a Marketing Cloud API Helper.
         </p>
         <p class="info-text">
            Para empezar, configura un cliente en "Configuración de APIs" y luego selecciónalo en el panel superior izquierdo.
         </p>
        </div>
      </div>
    </div>

    <!-- SECCIÓN: Documentación -->
    <div id="documentacion-section" class="section">
      <div class="section-header"><button class="back-button">← Atrás</button></div>
      <h2>Documentación</h2>
      <div class="tabs-container">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="configuracion-principal">Configuración Principal</button>
          <button class="tab-button" data-tab="guia-rapida">Guía Rápida</button>
          <button class="tab-button" data-tab="errores-comunes">Errores Comunes</button>
          <button class="tab-button" data-tab="comentarios-adicionales">Comentarios Adicionales</button>
        </div>
        <!-- Contenido de las Pestañas -->
        <div id="configuracion-principal" class="tab-content active">
          <h3>Configuración Principal</h3>
          <ul>
            <li><strong>Configurar un Cliente:</strong> Ve a <em>Configuración de APIs</em>. Introduce un nombre, rellena los datos de la app de MC (MID, Auth URI, etc.) y pulsa "Guardar".</li>
            <li><strong>Almacenamiento Local:</strong> La configuración se guarda en tu navegador. Si borras la caché, se perderá.</li>
            <li><strong>Selección de Cliente:</strong> Puedes guardar varias configuraciones y cambiar entre ellas usando los menús desplegables.</li>
          </ul>
        </div>
        <div id="guia-rapida" class="tab-content">
          <h3>Guía Rápida de Funcionalidades</h3>
          <ol>
              <li><b>Configuración de DE:</b> Define nombre, descripción, carpeta y si es enviable.</li>
              <li><b>Campos:</b> Añade campos manualmente, con el botón "Dummy" o importando desde el portapapeles.</li>
              <li><b>Crear DE / Campos:</b> Usa los botones "Crear Data Extension" o "Crear Campos" para ejecutar la acción.</li>
              <li><b>Gestión de Campos:</b> Recupera o borra campos de una DE existente. Especialmente útil para campos en Attribute Groups.</li>
              <li><b>Calendario:</b> Refresca los datos para ver las automatizaciones de Journeys programadas.</li>
              <li><b>Búsqueda y Validación:</b> Encuentra la ruta de una DE o valida la sintaxis de un email.</li>
              <li><b>Buscador de Orígenes:</b> Introduce el nombre de una DE para ver qué Queries o Imports la están rellenando.</li>
          </ol>
        </div>
        <div id="errores-comunes" class="tab-content">
            <h3>Errores Comunes</h3>
            <ul>
                <li><strong>Error de autenticación:</strong> Revisa que el MID, Client ID y Client Secret sean correctos. La app API debe ser de tipo "Server-to-Server".</li>
                <li><strong>La DE se crea en la raíz:</strong> Para carpetas, debes usar el <strong>ID de la Carpeta</strong> (un número), no su nombre.</li>
                <li><strong>DE Sendable sin Subscriber Key:</strong> Es <strong>obligatorio</strong> seleccionar un campo como Subscriber Key y que este sea requerido.</li>
                <li><strong>Error "Bad Request" con enlaces:</strong> Si pegas una URL en un campo con "&", reemplázalo por <code>&amp;amp;</code> en la tabla.</li>
            </ul>
        </div>
        <div id="comentarios-adicionales" class="tab-content">
            <h3>Comentarios Adicionales</h3>
            <ul>
              <li><strong>Permisos de la App API:</strong> Asegúrate de que la aplicación en MC tiene permisos de Lectura y Escritura para Data Extensions, Automatizaciones y Email.</li>
              <li><strong>"Crear campos" es un "upsert":</strong> Actualiza campos existentes o crea nuevos si no existen.</li>
              <li><strong>Longitud en Decimales:</strong> Usa el formato "total,decimales", por ejemplo, <code>18,2</code>.</li>
            </ul>
        </div>
      </div>
    </div>
    
    <!-- SECCIÓN: Calendario de Automatizaciones -->
    <div id="calendario-section" class="section">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
             <div class="calendar-controls">
                <label for="calendarYearSelect">Año:</label>
                <select id="calendarYearSelect"></select>
                <button id="refreshAutomationsBtn" class="action-button">Refrescar Datos</button>
            </div>
        </div>
        <h2>Calendario de Automatizaciones de Journeys</h2>
        <div class="calendar-container">
            <div id="calendar-main" class="calendar-main-view">
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            <aside id="calendar-sidebar" class="calendar-sidebar">
                <h3>Automatizaciones del Día</h3>
                <div id="automation-list">
                    <p>Selecciona un día para ver los detalles.</p>
                </div>
            </aside>
        </div>
    </div>

    <!-- SECCIÓN: Configuración de APIs -->
    <div id="configuracion-apis-section" class="section config-section-container">
         <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions"><button id="getTokenBtn" class="action-button">Recuperar Token</button></div>
        </div>
        <h2>Configuración de APIs</h2>
        <div class="client-management">
            <input type="text" id="clientName" placeholder="Nombre del Cliente">
            <select id="savedConfigs"></select>
            <button id="saveConfig">Guardar</button>
            <button id="deleteConfig" class="delete-btn">Borrar</button>
        </div>
        <div class="config-block">
            <h3>Datos Aplicación</h3>
            <div class="form-group"><label for="businessUnit">Business Unit (MID)</label><input type="text" id="businessUnit"></div>
            <div class="form-group"><label for="authUri">Auth URI</label><input type="text" id="authUri"></div>
            <div class="form-group"><label for="clientId">Client ID</label><input type="text" id="clientId"></div>
            <div class="form-group"><label for="clientSecret">Client Secret</label><input type="password" id="clientSecret"></div>
            <div class="form-group"><label for="token">Token</label><input type="text" id="token" disabled></div>
            <div class="form-group"><label for="soapUri">SOAP URI</label><input type="text" id="soapUri" disabled></div>
            <div class="form-group"><label for="restUri">REST URI</label><input type="text" id="restUri" disabled></div>
        </div>
        <p class="info-text">La configuración se guarda localmente en tu navegador.</p>
    </div>

    <!-- SECCIÓN: Configuración de Data Extension -->
    <div id="configuracion-de-section" class="section config-section-container">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions"><button id="createDE" class="action-button">Crear Data Extension</button></div>
        </div>
        <h2>Configuración de Data Extension</h2>
        <div class="config-block">
            <h3>Configuración Base</h3>
            <div class="form-group"><label for="deName">Nombre Data Extension</label><input type="text" id="deName"></div>
            <div class="form-group"><label for="deDescription">Descripción</label><input type="text" id="deDescription"></div>
            <div class="form-group"><label for="deExternalKey">External Key</label><input type="text" id="deExternalKey" disabled></div>
            <div class="form-group"><label for="deFolder">ID de Carpeta (Opcional)</label><input type="text" id="deFolder" placeholder="Ej: 12345"></div>
        </div>
        <div class="config-block">
            <h3>Configuración Sendable</h3>
            <div class="form-group checkbox-group">
                <label for="isSendable">Es Sendable:</label><input type="checkbox" id="isSendable">
            </div>
            <div class="form-group">
                <label for="subscriberKeyField">Campo SubscriberKey</label>
                <select id="subscriberKeyField" disabled><option value="">-- Defina campos en la sección 'Campos' --</option></select>
            </div>
            <div class="form-group"><label for="subscriberKeyType">Tipo Campo SubscriberKey</label><input type="text" id="subscriberKeyType" disabled></div>
        </div>
    </div>
    
    <!-- SECCIÓN: Búsqueda de Data Extension -->
    <div id="busqueda-de-section" class="section config-section-container">
        <button class="back-button">← Atrás</button>
        <h2>Búsqueda de Data Extension</h2>
        <div class="config-block">
            <h3>Parámetros de Búsqueda</h3>
            <div class="form-group">
              <label for="deSearchProperty">Buscar por:</label>
              <select id="deSearchProperty">
                <option value="Name">Nombre</option>
                <option value="CustomerKey">External Key</option>
              </select>
            </div>
            <div class="form-group">
              <label for="deSearchValue">Valor:</label>
              <input type="text" id="deSearchValue" placeholder="Ingresa el valor de búsqueda" maxlength="128">
            </div>
            <div class="header-actions" style="justify-content: center; margin-top: 20px;">
               <button id="searchDEBtn" class="action-button">Buscar</button>
            </div>
        </div>
        <div class="config-block">
            <h3>Resultados</h3>
            <pre id="de-search-results">La ruta de la Data Extension aparecerá aquí.</pre>
        </div>
    </div>

    <!-- SECCIÓN: Validador de Email -->
    <div id="email-validator-section" class="section config-section-container">
        <button class="back-button">← Atrás</button>
        <h2>Validador de Email</h2>
        <div class="config-block">
            <h3>Parámetros de Validación</h3>
            <div class="form-group">
              <label for="emailToValidate">Email a validar:</label>
              <input type="text" id="emailToValidate" placeholder="Introduce la dirección de email">
            </div>
            <div class="header-actions" style="justify-content: center; margin-top: 20px;">
               <button id="validateEmailBtn" class="action-button">Validar Email</button>
            </div>
        </div>
        <div class="config-block">
            <h3>Resultado de la Validación</h3>
            <pre id="email-validation-results">El resultado aparecerá aquí.</pre>
        </div>
    </div>
    
    <!-- SECCIÓN: Buscador de Orígenes de Datos -->
    <div id="data-source-finder-section" class="section config-section-container">
        <button class="back-button">← Atrás</button>
        <h2>Buscador de Orígenes de Datos</h2>
        <div class="config-block">
            <h3>Parámetros de Búsqueda</h3>
            <div class="form-group">
              <label for="deNameToFind">Nombre de la Data Extension:</label>
              <input type="text" id="deNameToFind" placeholder="Introduce el nombre exacto de la DE">
            </div>
            <div class="header-actions" style="justify-content: center; margin-top: 20px;">
               <button id="findDataSourcesBtn" class="action-button">Buscar Orígenes</button>
            </div>
        </div>
        <div class="config-block" style="flex-grow: 1; display: flex; flex-direction: column;">
            <h3>Actividades Encontradas</h3>
            <div class="table-container" style="flex-grow: 1; overflow-y: auto;">
                 <table id="data-sources-table">
                    <thead>
                        <tr>
                            <th>Actividad</th><th>Tipo</th><th>Automatización</th>
                            <th>Paso</th><th>Acción</th><th>Descripción / Query</th>
                        </tr>
                    </thead>
                    <tbody id="data-sources-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SECCIÓN: Gestión de Campos -->
    <div id="configuracion-campos-section" class="section config-section-container">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions">
                <button id="getFields" class="action-button">Recuperar Campos</button>
                <button id="deleteField" class="action-button delete-btn">Borrar Campo</button>
            </div>
        </div>
        <h2>Gestión de Campos de Data Extension</h2>
        <div class="config-block">
            <h3>Parámetros</h3>
            <p class="info-text" style="text-align: left; margin: 0 0 15px;">
                Introduce la External Key de la DE sobre la que quieres operar.
            </p>
            <div class="form-group">
                <label for="recExternalKey">External Key de la DE</label>
                <input type="text" id="recExternalKey">
            </div>
            <div class="form-group">
                <label for="targetFieldSelect">Campo a eliminar</label>
                <select id="targetFieldSelect" disabled><option value="">-- Pulsa "Recuperar Campos" para poblar --</option></select>
            </div>
        </div>
    </div>

    <!-- SECCIÓN: Campos de la Data Extension -->
    <div id="campos-section" class="section">
        <div class="section-header">
            <button class="back-button">← Atrás</button>
            <div class="header-actions">
                <button id="importFieldsBtn" class="action-button">Importar...</button>
                <button id="addFieldBtn" class="action-button">Añadir Fila</button>
                <button id="createFieldsBtn" class="action-button">Crear/Actualizar Campos</button>
                <button id="createDummyFieldsBtn" class="action-button">Campos de Ejemplo</button>                
                <button id="clearFieldsBtn" class="action-button delete-btn">Limpiar Tabla</button>
            </div>
        </div>
        <h2>Campos de la Data Extension</h2>
        <div class="table-container">
          <table id="myTable">
            <thead>
              <tr><th>Campo MC</th><th>Tipo Campo</th><th>Longitud</th><th>Default</th><th>PK</th><th>Requerido</th></tr>
            </thead>
            <tbody><!-- Las filas se insertan aquí con JS --></tbody>
          </table>
          <div class="control-buttons">
            <button id="moveUp" title="Mover fila seleccionada hacia arriba">Subir</button>
            <button id="moveDown" title="Mover fila seleccionada hacia abajo">Bajar</button>
          </div>
        </div>
    </div>
  </main> 
  <!-- END: CONTENIDO PRINCIPAL -->

  <!-- ========================================================== -->
  <!-- START: BARRA LATERAL DERECHA (LOG) -->
  <!-- ========================================================== -->
  <aside id="log-sidebar">
    <div class="log-header">
      <h2>Log de Eventos</h2>
      <button id="toggleLogBtn" title="Colapsar/Expandir Log"></button>
    </div>
    <div id="log-message-block" class="log-block">
      <h4>Mensajes</h4>
      <pre><code id="log-messages">Esperando acciones...</code></pre>
    </div>
    <div id="log-request-block" class="log-block">
      <h4>Llamada API</h4>
      <pre><code id="log-request"></code></pre>
    </div>
    <div id="log-response-block" class="log-block">
      <h4>Respuesta API</h4>
      <pre><code id="log-response"></code></pre>
    </div>
  </aside>
  <!-- END: BARRA LATERAL DERECHA -->

</div>
<!-- END: CONTENEDOR PRINCIPAL -->

<!-- ========================================================== -->
<!-- START: MODAL DE IMPORTACIÓN -->
<!-- ========================================================== -->
<div id="import-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Importar Campos desde Portapapeles</h3>
        <p>Pega aquí los datos. Las columnas deben ser: <b>Nombre</b>, <b>Tipo</b> y <b>Longitud</b> (opcional).</p>
        <div class="delimiter-selector">
            <label for="delimiter-select">Separador:</label>
            <select id="delimiter-select">
                <option value="tab" selected>Tabulador (Excel)</option>
                <option value="comma">Coma (,)</option>
                <option value="semicolon">Punto y coma (;)</option>
                <option value="other">Otro...</option>
            </select>
            <input type="text" id="custom-delimiter-input" class="hidden" maxlength="1" placeholder="|">
        </div>
        <textarea id="paste-data-area" rows="10" placeholder="Ciudad	Text	50&#10;Email	EmailAddress	254"></textarea>
        <div class="modal-actions">
            <button id="process-paste-btn" class="action-button">Añadir Campos</button>
            <button id="cancel-paste-btn" class="action-button delete-btn">Cancelar</button>
        </div>
    </div>
</div>
<!-- END: MODAL DE IMPORTACIÓN -->

<!-- Enlaza el fichero JavaScript al final del body para un rendimiento óptimo -->
<script src="ui.js"></script>
</body>
</html>